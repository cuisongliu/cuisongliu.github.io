<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.66.0-DEV with theme Tranquilpeak 0.4.7-BETA">
<meta name="author" content="cuisongliu">
<meta name="keywords" content=", development, kubenetes">
<meta name="description" content="本文主要讲解kubernetes的admission webhook双向认证证书生成流程。">


<meta property="og:description" content="本文主要讲解kubernetes的admission webhook双向认证证书生成流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes 之 admission webhook生成证书">
<meta name="twitter:title" content="kubernetes 之 admission webhook生成证书">
<meta property="og:url" content="https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">
<meta property="twitter:url" content="https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">
<meta property="og:site_name" content="cuisongliu 的个人博客">
<meta property="og:description" content="本文主要讲解kubernetes的admission webhook双向认证证书生成流程。">
<meta name="twitter:description" content="本文主要讲解kubernetes的admission webhook双向认证证书生成流程。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2020-07-21T00:00:00">
  
  
    <meta property="article:modified_time" content="2020-07-21T00:00:00">
  
  
  
    
      <meta property="article:section" content="kubernetes">
    
      <meta property="article:section" content="admission">
    
      <meta property="article:section" content="webhook">
    
  
  
    
      <meta property="article:tag" content="kubernetes">
    
      <meta property="article:tag" content="webhook">
    
  


<meta name="twitter:card" content="summary">











  <meta property="og:image" content="https://www.gravatar.com/avatar/130d14faedf30e83c0e41f375ba21f30?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/130d14faedf30e83c0e41f375ba21f30?s=640">


    <title>kubernetes 之 admission webhook生成证书</title>

    <link rel="icon" href="https://cuisongliu.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://cuisongliu.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://cuisongliu.github.io/">cuisongliu 的个人博客</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://cuisongliu.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/130d14faedf30e83c0e41f375ba21f30?s=90" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://cuisongliu.github.io/#about">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/130d14faedf30e83c0e41f375ba21f30?s=110" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">cuisongliu</h4>
        
          <h5 class="sidebar-profile-bio">疯狂源于梦想,技术成就辉煌。</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://cuisongliu.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://cuisongliu.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://cuisongliu.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/cuisongliu" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://cuisongliu.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://cuisongliu.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://cuisongliu.github.io/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      kubernetes 之 admission webhook生成证书
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2020-07-21T00:00:00Z">
        
  七月 21, 2020

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="https://cuisongliu.github.io/categories/kubernetes">kubernetes</a>, 
    
      <a class="category-link" href="https://cuisongliu.github.io/categories/admission">admission</a>, 
    
      <a class="category-link" href="https://cuisongliu.github.io/categories/webhook">webhook</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>本文主要讲解kubernetes的admission webhook双向认证证书生成流程。</p>
<!-- raw HTML omitted -->
<blockquote>
<p><a href="https://sealyun.com/pro/products/">kubernetes集群三步安装</a></p>
</blockquote>
<div class="alert info ">
  <p>其实就是使用kubernetes的csr生成证书：</p>
<ul>
<li>自建一个私钥</li>
<li>根据自建私钥生成一个csr文件</li>
<li>把生成的csr提交给kubernetes的csr资源使用kubernetes进行证书签发(其实本质就是拿kubernetes的ca的证书进行签发的)</li>
<li>最后别忘记把ca证书设置给webhook资源的caBundle字段</li>
</ul></p>
</div>
<h3 id="手动签发证书">手动签发证书</h3>
<div class="alert warning ">
  <p>这里需要注意一下: 需要根据部署的service的名称和namespace设置对应的name和namespace。</p>
</div>
<p>这里我们提前设置一下访问的service的名称是 webhook-svc所在的namespace是 webhook,所设置kubernetes的csr资源叫webhook-csr</p>
<h4 id="设置证书配置">设置证书配置</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight conf language-conf">
  <figcaption>
    
      <span>csr.conf</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e8%ae%be%e7%bd%ae%e8%af%81%e4%b9%a6%e9%85%8d%e7%bd%ae" target="_blank" rel="external">csr.conf</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-conf"><code class="conf">[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names
[alt_names]
DNS.1 = webhook-svc
DNS.2 = webhook-svc.webhook
DNS.3 = webhook-svc.webhook.svc</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="生成秘钥和csr文件">生成秘钥和csr文件</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight bash language-bash">
  <figcaption>
    
      <span>csr.bash</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e7%94%9f%e6%88%90%e7%a7%98%e9%92%a5%e5%92%8ccsr%e6%96%87%e4%bb%b6" target="_blank" rel="external">csr.bash</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-bash"><code class="bash">#!/bin/bash
openssl genrsa -out server-key.pem 2048
openssl req -new -key server-key.pem -subj &#34;/CN=webhook-svc.webhook.svc&#34; -days 36500 -out server.csr -config csr.conf</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="使用kubernetes签发证书">使用kubernetes签发证书</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight bash language-bash">
  <figcaption>
    
      <span>csr-k8s.sh</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e4%bd%bf%e7%94%a8kubernetes%e7%ad%be%e5%8f%91%e8%af%81%e4%b9%a6" target="_blank" rel="external">csr-k8s.sh</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-bash"><code class="bash">#!/bin/bash
kubectl delete csr webhook-csr  2&gt;/dev/null || true

cat &lt;&lt;EOF | kubectl create -f -
apiVersion: certificates.k8s.io/v1beta1
kind: CertificateSigningRequest
metadata:
  name: webhook-csr
spec:
  groups:
  - system:authenticated
  request: $(cat server.csr | base64 | tr -d &#39;\n&#39;)
  usages:
  - digital signature
  - key encipherment
  - server auth
EOF

# 重新认证csr
kubectl certificate approve webhook-csr
# 这里需要重试几次,需要等kubernetes签发证书后才会有status信息
for x in $(seq 10); do
    serverCert=$(kubectl get csr webhook-csr -o jsonpath=&#39;{.status.certificate}&#39;)
    if [[ ${serverCert} != &#39;&#39; ]]; then
        break
    fi
    sleep 1
done

echo ${serverCert} | openssl base64 -d -A -out server-cert.pem</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="设置ca证书给对应的webhook资源">设置ca证书给对应的webhook资源</h4>
<p>这里需要把ca的base64值证书设置给对应的MutatingWebhookConfiguration和ValidatingWebhookConfiguration的caBundle字段。这里就不详细赘述了,说明一下ca证书如何获取。</p>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight bash language-bash">
  <figcaption>
    
      <span>ca-k8s.sh</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e8%ae%be%e7%bd%aeca%e8%af%81%e4%b9%a6%e7%bb%99%e5%af%b9%e5%ba%94%e7%9a%84webhook%e8%b5%84%e6%ba%90" target="_blank" rel="external">ca-k8s.sh</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-bash"><code class="bash">#!/bin/bash
export caBundle=$(kubectl get configmap -n kube-system extension-apiserver-authentication -o=jsonpath=&#39;{.data.client-ca-file}&#39; | base64 | tr -d &#39;\n&#39;)
echo $caBundle</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="手动签发证书的问题">手动签发证书的问题</h4>
<div class="alert danger ">
  <p>使用手动签发证书需要每次启动项目之前都要把证书准备好并设置到项目中去,如果证书更改就需要重新签发。比较麻烦，于是我们可以使用代码进行签发证书。</p>
</div>
<h3 id="使用代码签发证书">使用代码签发证书</h3>
<div class="alert success ">
  <p>其实流程跟手动签发流程基本一致:</p>
<ul>
<li>读取秘钥中存储的私钥和csr(证书相关信息存储到秘钥中),若不存在自动生成证书(私钥和csr)并存储到秘钥中</li>
<li>根据生成的证书提交给kubernetes中进行ca证书签名出公钥信息并存储到秘钥中</li>
<li>读取ca证书并存储到秘钥中</li>
<li>根据ca证书修改对应的MutatingWebhookConfiguration和ValidatingWebhookConfiguration</li>
<li>读取出证书信息写入本地目录提供pod使用证书(需要在https的服务启动之前设置好)</li>
</ul></p>
</div>
<div class="alert warning ">
  <p>需要提前设置一下相关信息:</p>
<ul>
<li>service的名称和namespace分别为webhook-svc和webhook</li>
<li>存储的秘钥信息为webhook-secrets</li>
<li>设置的kubernetes的csr信息为webhook-csr</li>
<li>MutatingWebhookConfiguration名称为webhook-mutate,ValidatingWebhookConfiguration为webhook-validate</li>
<li>写入的目录为 /etc/kubernetes/webhhok/tls</li>
</ul></p>
</div>
<h4 id="生成证书数据">生成证书数据</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight go language-go">
  <figcaption>
    
      <span>key.go</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e7%94%9f%e6%88%90%e8%af%81%e4%b9%a6%e6%95%b0%e6%8d%ae" target="_blank" rel="external">key.go</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-go"><code class="go">type CertConfig struct {
	CommonName   string
	Organization []string
	// AltNames contains the domain names and IP addresses that will be added
	// to the API Server&#39;s x509 certificate SubAltNames field. The values will
	// be passed directly to the x509.Certificate object.
	AltNames struct {
		DNSNames []string
		IPs      []net.IP
	}
}
// NewPrivateKey creates an RSA private key
func NewPrivateKey(keyType x509.PublicKeyAlgorithm) (crypto.Signer, error) {
	if keyType == x509.ECDSA {
		return ecdsa.GenerateKey(elliptic.P256(), rand.Reader)
	}
	return rsa.GenerateKey(rand.Reader, 2048)
}

func NewSigned(cfg CertConfig) (csr, keyPEM []byte, err error) {
	key, err := NewPrivateKey(x509.RSA)
	if err != nil {
		return nil, nil, fmt.Errorf(&#34;new signed private failed %s&#34;, err)
	}
	pk := x509.MarshalPKCS1PrivateKey(key.(*rsa.PrivateKey))
	keyPEM = pem.EncodeToMemory(&amp;pem.Block{
		Type: &#34;RSA PRIVATE KEY&#34;, Bytes: pk,
	})
	_, csr, err = GenerateCSR(cfg, key)
	csr = pem.EncodeToMemory(&amp;pem.Block{
		Type: &#34;CERTIFICATE REQUEST&#34;, Bytes: csr,
	})
	if err != nil {
		return nil, nil, fmt.Errorf(&#34;new signed csr failed %s&#34;, err)
	}
	return
}

// GenerateCSR will generate a new *x509.CertificateRequest template to be used
// by issuers that utilise CSRs to obtain Certificates.
// The CSR will not be signed, and should be passed to either EncodeCSR or
// to the x509.CreateCertificateRequest function.
func GenerateCSR(cfg CertConfig, key crypto.Signer) (*x509.CertificateRequest, []byte, error) {
	if len(cfg.CommonName) == 0 {
		return nil, nil, errors.New(&#34;must specify a CommonName&#34;)
	}
	var dnsNames []string
	var ips []net.IP
	for _, v := range cfg.AltNames.DNSNames {
		dnsNames = append(dnsNames, v)
	}
	for _, v := range cfg.AltNames.IPs {
		ips = append(ips, v)
	}
	certTmpl := x509.CertificateRequest{
		Subject: pkix.Name{
			CommonName:   cfg.CommonName,
			Organization: cfg.Organization,
		},
		DNSNames:    dnsNames,
		IPAddresses: ips,
	}
	certDERBytes, err := x509.CreateCertificateRequest(rand.Reader, &amp;certTmpl, key)
	if err != nil {
		return nil, nil, err
	}
	r1, r3 := x509.ParseCertificateRequest(certDERBytes)
	return r1, certDERBytes, r3
}
func generateTLS() (csr []byte, key []byte, err error) {
	host := fmt.Sprintf(&#34;%s.%s&#34;, &#34;webhook-svc&#34;, &#34;webhook&#34;)
	dnsNames := []string{
		host,
		fmt.Sprintf(&#34;%s.svc&#34;, host),
		fmt.Sprintf(&#34;%s.svc.cluster.local&#34;, host),
	}
	cfg := CertConfig{
		CommonName:   host,
		Organization: []string{&#34;selyun.com&#34;},
		AltNames: struct {
			DNSNames []string
			IPs      []net.IP
		}{
			DNSNames: dnsNames,
		},
	}
	csr, key, err = NewSigned(cfg)
	return
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="生成证书数据并存储到秘钥">生成证书数据并存储到秘钥</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight go language-go">
  <figcaption>
    
      <span>cert.go</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e7%94%9f%e6%88%90%e8%af%81%e4%b9%a6%e6%95%b0%e6%8d%ae%e5%b9%b6%e5%ad%98%e5%82%a8%e5%88%b0%e7%a7%98%e9%92%a5" target="_blank" rel="external">cert.go</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-go"><code class="go">const (
	certKey     = &#34;tls.crt&#34;
	keyKey      = &#34;tls.key&#34;
	csrKey      = &#34;tls.csr&#34;
	caBundleKey = &#34;caBundle&#34;
)
func generateSecret() (*corev1.Secret, error) {
    secret, err := clientset.CoreV1().Secrets(&#34;webhook&#34;).Get(&#34;webhook-secrets&#34;, v1.GetOptions{})
    if err != nil {
        if !errors.IsNotFound(err) {
            return nil, err
        }
        csr, key, err := generateTLS()
        if err != nil {
            return nil, err
        }
        secret = &amp;corev1.Secret{
            ObjectMeta: v1.ObjectMeta{
                Namespace: &#34;webhook&#34;,
                Name:      &#34;webhook-secrets&#34;,
            },
            Data: map[string][]byte{
                csrKey: csr,
                keyKey: key,
            },
        }
        secret, err = clientset.CoreV1().Secrets(&#34;webhook&#34;).Create(secret)
        if err != nil {
            return nil, err
        }
    }
    return secret,nil
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="使用csr使用kubernetes签发公钥">使用csr使用kubernetes签发公钥</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight go language-go">
  <figcaption>
    
      <span>csr.go</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e4%bd%bf%e7%94%a8csr%e4%bd%bf%e7%94%a8kubernetes%e7%ad%be%e5%8f%91%e5%85%ac%e9%92%a5" target="_blank" rel="external">csr.go</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-go"><code class="go">const (
	certKey     = &#34;tls.crt&#34;
	keyKey      = &#34;tls.key&#34;
	csrKey      = &#34;tls.csr&#34;
	caBundleKey = &#34;caBundle&#34;
)
func pathCsr(secret *corev1.Secret) error {
	dPolicy := v1.DeletePropagationBackground
	label := map[string]string{
		&#34;csr-name&#34;: &#34;webhook-csr&#34;,
	}
	_ = clientset.CertificatesV1beta1().CertificateSigningRequests().Delete(&#34;webhook-csr&#34;, &amp;v1.DeleteOptions{PropagationPolicy: &amp;dPolicy})
	csrResource := &amp;v1beta1.CertificateSigningRequest{}
	csrResource.Name = &#34;webhook-csr&#34;
	csrResource.Labels = label
	csrResource.Spec.Groups = []string{&#34;system:authenticated&#34;}
	csrResource.Spec.Usages = []v1beta1.KeyUsage{
		&#34;digital signature&#34;,
		&#34;key encipherment&#34;,
		&#34;server auth&#34;,
	}
	csrResource.Spec.Request = secret.Data[csrKey]
	csrResource, err := clientset.CertificatesV1beta1().CertificateSigningRequests().Create(csrResource)
	if err != nil {
		return err
	}
	csrResource.Status.Conditions = []v1beta1.CertificateSigningRequestCondition{
		{Type: v1beta1.CertificateApproved, Reason: &#34;PodSelfApprove&#34;, Message: &#34;This CSR was approved by pod certificate approve.&#34;, LastUpdateTime: v1.NewTime(time.Now())},
	}
	csrResource, err = clientset.CertificatesV1beta1().CertificateSigningRequests().UpdateApproval(csrResource)
	if err != nil {
		return err
	}
	w, err := clientset.CertificatesV1beta1().CertificateSigningRequests().Watch(v1.ListOptions{LabelSelector: &#34;csr-name=&#34; &#43; &#34;webhook-csr&#34;})
	if err != nil {
		return err
	}
	for {
		select {
		case &lt;-time.After(time.Second * 10):
			return errors.NewBadRequest(&#34;The CSR is not ready.&#34;)
		case event := &lt;-w.ResultChan():
			if event.Type == watch.Modified || event.Type == watch.Added {
				csr := event.Object.(*v1beta1.CertificateSigningRequest)
				if csr.Status.Certificate != nil {
					secret.Data[certKey] = csr.Status.Certificate
					return nil
				}
			}
		}
	}
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="获取ca证书并修改webhook资源">获取ca证书并修改webhook资源</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight go language-go">
  <figcaption>
    
      <span>ca.go</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e8%8e%b7%e5%8f%96ca%e8%af%81%e4%b9%a6%e5%b9%b6%e4%bf%ae%e6%94%b9webhook%e8%b5%84%e6%ba%90" target="_blank" rel="external">ca.go</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-go"><code class="go">func ca(secret *corev1.Secret) (*corev1.Secret, error){
    caConfigMap, err := clientset.CoreV1().ConfigMaps(&#34;kube-system&#34;).Get(&#34;extension-apiserver-authentication&#34;, v1.GetOptions{})
	if err != nil {
		return nil, err
	}
	var caData string
	if caConfigMap != nil {
		caData = caConfigMap.Data[&#34;client-ca-file&#34;]
	} else {
		return nil, errors.NewUnauthorized(&#34;ca configmap [extension-apiserver-authentication] data [client-ca-file] is not found.&#34;)
	}
	secret.Data[caBundleKey] = []byte(caData)
	secret, err = clientset.CoreV1().Secrets(secret.Namespace).Update(secret)
	if err != nil {
		return nil, err
	}
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="根据ca数据修改webhook资源">根据ca数据修改webhook资源</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight go language-go">
  <figcaption>
    
      <span>webhook.go</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e6%a0%b9%e6%8d%aeca%e6%95%b0%e6%8d%ae%e4%bf%ae%e6%94%b9webhook%e8%b5%84%e6%ba%90" target="_blank" rel="external">webhook.go</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-go"><code class="go">const (
	certKey     = &#34;tls.crt&#34;
	keyKey      = &#34;tls.key&#34;
	csrKey      = &#34;tls.csr&#34;
	caBundleKey = &#34;caBundle&#34;
)
func () patchWebHook(secret *corev1.Secret) error {
    caBundle:=secret.Data[caBundleKey]
    validatingName:=&#34;webhook-validate&#34;
    mutatingName:=&#34;webhook-mutate&#34;
    {
        vwebhook, err := clientset.AdmissionregistrationV1().ValidatingWebhookConfigurations().Get(validatingName, v1.GetOptions{})
        if err != nil {
            return err
        }
        for i := range vwebhook.Webhooks {
            vwebhook.Webhooks[i].ClientConfig.Service.Name = &#34;webhook-svc&#34;
            vwebhook.Webhooks[i].ClientConfig.CABundle = caBundle
        }
        _, err = clientset.AdmissionregistrationV1().ValidatingWebhookConfigurations().Update(vwebhook)
        if err != nil {
            return err
        }
    }
    {
        mwebhook, err := clientset.AdmissionregistrationV1().MutatingWebhookConfigurations().Get(mutatingName, v1.GetOptions{})
        if err != nil {
            return err
        }
        for i := range mwebhook.Webhooks {
            mwebhook.Webhooks[i].ClientConfig.Service.Name = &#34;webhook-svc&#34;
            mwebhook.Webhooks[i].ClientConfig.CABundle = caBundle
        }
        _, err = clientset.AdmissionregistrationV1().MutatingWebhookConfigurations().Update(mwebhook)
        if err != nil {
            return err
        }
    }
	return nil
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
<h4 id="把存储的秘钥写入文件夹">把存储的秘钥写入文件夹</h4>

  
    
  
  
    
  
  
    
  
  
    
  


<figure class="highlight go language-go">
  <figcaption>
    
      <span>write.go</span><a href="http://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/#%e6%8a%8a%e5%ad%98%e5%82%a8%e7%9a%84%e7%a7%98%e9%92%a5%e5%86%99%e5%85%a5%e6%96%87%e4%bb%b6%e5%a4%b9" target="_blank" rel="external">write.go</a>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-go"><code class="go">const (
	certKey     = &#34;tls.crt&#34;
	keyKey      = &#34;tls.key&#34;
	csrKey      = &#34;tls.csr&#34;
	caBundleKey = &#34;caBundle&#34;
)
func (c *CertWebHook) writeTLSFiles(secret *corev1.Secret) error {
    certData:=secret.Data[certKey]
    keyData:=secret.Data[keyKey]
    certDir:=&#34;/etc/kubernetes/webhhok/tls&#34;
	if _, err := os.Stat(certDir); os.IsNotExist(err) {
		if err := os.MkdirAll(certDir, 0700); err != nil {
			return err
		}
	}
	if err := ioutil.WriteFile(path.Join(certDir, &#34;tls.crt&#34;), certData, 0600); err != nil {
		return err
	}
	if err := ioutil.WriteFile(path.Join(certDir, &#34;tls.key&#34;), keyData, 0600); err != nil {
		return err
	}
	return nil
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://cuisongliu.github.io/tags/kubernetes/">kubernetes</a>

  <a class="tag tag--primary tag--small" href="https://cuisongliu.github.io/tags/webhook/">webhook</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav style="visibility: hidden">
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://cuisongliu.github.io/2020/05/kubernetes/admission-controller/" data-tooltip="kubernetes 之 admission controller原理">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2020 <a href="https://github.com/cuisongliu">cuisongliu</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav style="visibility: hidden">
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://cuisongliu.github.io/2020/05/kubernetes/admission-controller/" data-tooltip="kubernetes 之 admission controller原理">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">
              <i class="fa fa-facebook-official"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://cuisongliu.github.io/2020/07/kubernetes/admission-webhook/">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcuisongliu.github.io%2F2020%2F07%2Fkubernetes%2Fadmission-webhook%2F">
          <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fcuisongliu.github.io%2F2020%2F07%2Fkubernetes%2Fadmission-webhook%2F">
          <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/130d14faedf30e83c0e41f375ba21f30?s=110" alt="作者的图片" />
    
    <h4 id="about-card-name">cuisongliu</h4>
    
      <div id="about-card-bio">疯狂源于梦想,技术成就辉煌。</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Kubenetes开发
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        天津
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://cuisongliu.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://cuisongliu.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script async crossorigin="anonymous" defer integrity="sha256-putofyQv7OB569xAldpyBnHJ0Uc+7VGp5Us05IgDGss=" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/languages/dockerfile.min.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/cuisongliu.github.io\/2020\/07\/kubernetes\/admission-webhook\/';
          
            this.page.identifier = '\/2020\/07\/kubernetes\/admission-webhook\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'cuisongliu';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

